// ============================================================
// 04_borrowing.rs - å€Ÿç”¨ï¼ˆBorrowingï¼‰ä¸Žå¼•ç”¨
// ============================================================
//
// ðŸŽ¯ å­¦ä¹ ç›®æ ‡ï¼šç†è§£å€Ÿç”¨æœºåˆ¶
//
// å€Ÿç”¨å…è®¸ä½ ä½¿ç”¨å€¼è€Œä¸èŽ·å–æ‰€æœ‰æƒ
// &T  - ä¸å¯å˜å¼•ç”¨ï¼ˆå¯ä»¥åŒæ—¶æœ‰å¤šä¸ªï¼‰
// &mut T - å¯å˜å¼•ç”¨ï¼ˆåŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªï¼‰
//
// è¿è¡Œæ–¹å¼: cargo run --example 04_borrowing
// ============================================================

fn main() {
    println!("=== å€Ÿç”¨ï¼ˆBorrowingï¼‰è¯¦è§£ ===\n");

    // --------------------------------------------------------
    // ðŸ“Œ é—®é¢˜å¼•å…¥ï¼šæ²¡æœ‰å€Ÿç”¨æ—¶çš„å›°å¢ƒ
    // --------------------------------------------------------
    println!("ã€1ã€‘é—®é¢˜ï¼šæ²¡æœ‰å€Ÿç”¨æ—¶çš„å›°å¢ƒ");
    println!();

    let s1 = String::from("hello");
    let len = calculate_length_bad(s1);  // s1 æ‰€æœ‰æƒè¢«è½¬ç§»
    // println!("s1 = {}", s1);  // âŒ ç¼–è¯‘é”™è¯¯ï¼s1 å·²å¤±æ•ˆ
    println!("  é•¿åº¦æ˜¯: {}", len);
    println!("  ä½†æ˜¯åŽŸå­—ç¬¦ä¸²å·²ç»æ— æ³•ä½¿ç”¨äº†...");
    println!();

    // ç¬¨æ‹™çš„è§£å†³æ–¹æ¡ˆï¼šå‡½æ•°è¿”å›žæ‰€æœ‰æƒ
    let s2 = String::from("world");
    let (s2_back, len2) = calculate_length_awkward(s2);
    println!("  ç¬¨æ‹™æ–¹æ¡ˆï¼šè®©å‡½æ•°è¿”å›žæ‰€æœ‰æƒ");
    println!("  s2 = \"{}\", é•¿åº¦ = {}", s2_back, len2);
    println!("  è¿™æ ·å¤ªç¹çäº†ï¼");
    println!();

    // --------------------------------------------------------
    // ðŸ“Œ è§£å†³æ–¹æ¡ˆï¼šå€Ÿç”¨
    // --------------------------------------------------------
    println!("ã€2ã€‘è§£å†³æ–¹æ¡ˆï¼šå€Ÿç”¨ï¼ˆBorrowingï¼‰");
    println!();

    let s3 = String::from("Rust");
    let len3 = calculate_length(&s3);  // ä¼ é€’å¼•ç”¨ï¼Œä¸è½¬ç§»æ‰€æœ‰æƒ

    println!("  ä½¿ç”¨å€Ÿç”¨: calculate_length(&s3)");
    println!("  s3 = \"{}\"", s3);  // âœ… s3 ä»ç„¶æœ‰æ•ˆï¼
    println!("  é•¿åº¦ = {}", len3);
    println!();

    // --------------------------------------------------------
    // ðŸ“Œ å€Ÿç”¨çš„å›¾è§£
    // --------------------------------------------------------
    println!("ã€3ã€‘å€Ÿç”¨çš„å†…å­˜å›¾è§£");
    println!();
    println!("  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”");
    println!("  â”‚     s3      â”‚ (æ‰€æœ‰è€…)");
    println!("  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”");
    println!("  â”‚ ptr â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€>â”‚ R â”‚ u â”‚ s â”‚ t â”‚");
    println!("  â”‚ len = 4     â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜");
    println!("  â”‚ capacity = 4â”‚           å †å†…å­˜");
    println!("  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜");
    println!("        â†‘");
    println!("        â”‚ å¼•ç”¨");
    println!("  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”");
    println!("  â”‚    &s3      â”‚ (å€Ÿç”¨è€…ï¼Œåªè¯»å–ä¸æ‹¥æœ‰)");
    println!("  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜");
    println!();

    // --------------------------------------------------------
    // ðŸ“Œ ä¸å¯å˜å€Ÿç”¨çš„è§„åˆ™
    // --------------------------------------------------------
    println!("ã€4ã€‘ä¸å¯å˜å€Ÿç”¨ (&T) çš„è§„åˆ™");
    println!();

    let text = String::from("å…±äº«æ•°æ®");

    // å¯ä»¥åŒæ—¶æœ‰å¤šä¸ªä¸å¯å˜å€Ÿç”¨
    let r1 = &text;
    let r2 = &text;
    let r3 = &text;

    println!("  å¯ä»¥åŒæ—¶åˆ›å»ºå¤šä¸ªä¸å¯å˜å¼•ç”¨:");
    println!("    r1 = \"{}\"", r1);
    println!("    r2 = \"{}\"", r2);
    println!("    r3 = \"{}\"", r3);
    println!("    text = \"{}\"", text);  // åŽŸå€¼ä¹Ÿå¯ä»¥è¯»å–
    println!();

    println!("  ðŸ’¡ ä¸ºä»€ä¹ˆå…è®¸å¤šä¸ªä¸å¯å˜å€Ÿç”¨ï¼Ÿ");
    println!("     å› ä¸ºåªè¯»ä¸ä¼šäº§ç”Ÿæ•°æ®ç«žäº‰ï¼");
    println!();

    // --------------------------------------------------------
    // ðŸ“Œ å€Ÿç”¨ä¸èƒ½ä¿®æ”¹
    // --------------------------------------------------------
    println!("ã€5ã€‘ä¸å¯å˜å€Ÿç”¨ä¸èƒ½ä¿®æ”¹å€¼");
    println!();

    let greeting = String::from("Hello");
    let ref_greeting = &greeting;

    // ä¸‹é¢è¿™è¡Œå¦‚æžœå–æ¶ˆæ³¨é‡Šï¼Œä¼šç¼–è¯‘é”™è¯¯ï¼š
    // ref_greeting.push_str(" World");  // âŒ cannot borrow as mutable

    println!("  ref_greeting æ˜¯ &Stringï¼Œä¸èƒ½è°ƒç”¨ä¿®æ”¹æ–¹æ³•");
    println!("  ref_greeting = \"{}\"", ref_greeting);
    println!();

    // --------------------------------------------------------
    // ðŸ“Œ å€Ÿç”¨çš„ç”Ÿå‘½å‘¨æœŸè§„åˆ™
    // --------------------------------------------------------
    println!("ã€6ã€‘å€Ÿç”¨å¿…é¡»åœ¨æ‰€æœ‰è€…æœ‰æ•ˆæœŸå†…");
    println!();

    // æ­£ç¡®çš„ç”¨æ³•
    let valid_ref;
    {
        let owner = String::from("æˆ‘æ˜¯æ‰€æœ‰è€…");
        valid_ref = &owner;
        println!("  ä½œç”¨åŸŸå†…: valid_ref = \"{}\"", valid_ref);  // âœ…
    }  // owner åœ¨è¿™é‡Œè¢«é‡Šæ”¾
    // println!("{}", valid_ref);  // âŒ æ‚¬åž‚å¼•ç”¨ï¼ç¼–è¯‘å™¨ä¼šé˜»æ­¢

    println!("  ä½œç”¨åŸŸå¤–: owner å·²é‡Šæ”¾ï¼Œå¼•ç”¨å¤±æ•ˆ");
    println!();

    println!("  ðŸ’¡ Rust ç¼–è¯‘å™¨é€šè¿‡ã€Œç”Ÿå‘½å‘¨æœŸã€æ£€æŸ¥æ¥ä¿è¯å¼•ç”¨å§‹ç»ˆæœ‰æ•ˆ");
    println!();

    // --------------------------------------------------------
    // ðŸ“Œ å®žé™…åº”ç”¨ç¤ºä¾‹
    // --------------------------------------------------------
    println!("ã€7ã€‘å®žé™…åº”ç”¨ç¤ºä¾‹");
    println!();

    let sentence = String::from("The quick brown fox");

    // å¯ä»¥ä¼ é€’å€Ÿç”¨ç»™å¤šä¸ªå‡½æ•°
    println!("  åŽŸå¥: \"{}\"", sentence);
    println!("  é•¿åº¦: {}", get_length(&sentence));
    println!("  ç¬¬ä¸€ä¸ªå­—ç¬¦: {:?}", first_char(&sentence));
    println!("  æ˜¯å¦åŒ…å« 'fox': {}", contains_word(&sentence, "fox"));
    println!("  åŽŸå¥ä»ç„¶æœ‰æ•ˆ: \"{}\"", sentence);  // âœ…
    println!();

    println!("=== ç¤ºä¾‹ç»“æŸ ===");
    println!("\nðŸ“š ä¸‹ä¸€æ­¥å­¦ä¹ : cargo run --example 05_mutable_borrow");

    wait_for_enter();
}

// âŒ ä¸å¥½çš„è®¾è®¡ï¼šèŽ·å–æ‰€æœ‰æƒ
fn calculate_length_bad(s: String) -> usize {
    s.len()
}  // s è¢«é‡Šæ”¾

// ðŸ¤” ç¬¨æ‹™çš„è®¾è®¡ï¼šè¿”å›žæ‰€æœ‰æƒ
fn calculate_length_awkward(s: String) -> (String, usize) {
    let length = s.len();
    (s, length)  // è¿”å›žæ‰€æœ‰æƒå’Œé•¿åº¦
}

// âœ… å¥½çš„è®¾è®¡ï¼šä½¿ç”¨å€Ÿç”¨
fn calculate_length(s: &String) -> usize {
    s.len()
}  // s æ˜¯å¼•ç”¨ï¼Œä¸ä¼šé‡Šæ”¾ä»»ä½•ä¸œè¥¿

fn get_length(s: &String) -> usize {
    s.len()
}

fn first_char(s: &String) -> Option<char> {
    s.chars().next()
}

fn contains_word(s: &String, word: &str) -> bool {
    s.contains(word)
}

fn wait_for_enter() {
    use std::io::{self, Write};
    println!();
    print!("æŒ‰å›žè½¦é”®é€€å‡º...");
    io::stdout().flush().unwrap();
    let mut input = String::new();
    io::stdin().read_line(&mut input).unwrap();
}
