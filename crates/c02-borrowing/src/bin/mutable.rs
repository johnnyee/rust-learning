// ============================================================
// 05_mutable_borrow.rs - å¯å˜å€Ÿç”¨ï¼ˆ&mut Tï¼‰
// ============================================================
//
// ğŸ¯ å­¦ä¹ ç›®æ ‡ï¼šç†è§£å¯å˜å€Ÿç”¨çš„è§„åˆ™
//
// æ ¸å¿ƒè§„åˆ™ï¼šåœ¨ä»»æ„æ—¶åˆ»ï¼Œè¦ä¹ˆ
//   - åªèƒ½æœ‰ä¸€ä¸ªå¯å˜å¼•ç”¨ï¼ˆ&mut Tï¼‰
//   - æˆ–è€…å¯ä»¥æœ‰å¤šä¸ªä¸å¯å˜å¼•ç”¨ï¼ˆ&Tï¼‰
//   - ä½†ä¸èƒ½åŒæ—¶å­˜åœ¨ï¼
//
// è¿è¡Œæ–¹å¼: cargo run --example 05_mutable_borrow
// ============================================================

fn main() {
    println!("=== å¯å˜å€Ÿç”¨è¯¦è§£ ===\n");

    // --------------------------------------------------------
    // ğŸ“Œ å¯å˜å€Ÿç”¨çš„åŸºæœ¬ç”¨æ³•
    // --------------------------------------------------------
    println!("ã€1ã€‘å¯å˜å€Ÿç”¨çš„åŸºæœ¬ç”¨æ³•");
    println!();

    let mut s = String::from("Hello");
    println!("  åŸå§‹å€¼: \"{}\"", s);

    // åˆ›å»ºå¯å˜å€Ÿç”¨
    let r = &mut s;
    r.push_str(" World");

    println!("  ä¿®æ”¹å: \"{}\"", r);
    println!();

    // --------------------------------------------------------
    // ğŸ“Œ è§„åˆ™ï¼šåŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªå¯å˜å€Ÿç”¨
    // --------------------------------------------------------
    println!("ã€2ã€‘è§„åˆ™ï¼šåŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªå¯å˜å€Ÿç”¨");
    println!();

    let mut data = String::from("æ•°æ®");

    let r1 = &mut data;
    // let r2 = &mut data;  // âŒ ç¼–è¯‘é”™è¯¯ï¼ä¸èƒ½åŒæ—¶æœ‰ä¸¤ä¸ªå¯å˜å€Ÿç”¨
    // println!("{} {}", r1, r2);

    r1.push_str("ä¿®æ”¹");
    println!("  r1 ä¿®æ”¹å: \"{}\"", r1);
    println!();

    println!("  ğŸ’¡ ä¸ºä»€ä¹ˆåªå…è®¸ä¸€ä¸ªå¯å˜å€Ÿç”¨ï¼Ÿ");
    println!("     é˜²æ­¢æ•°æ®ç«äº‰ï¼ˆdata raceï¼‰ï¼");
    println!("     å¦‚æœä¸¤ä¸ªæŒ‡é’ˆåŒæ—¶ä¿®æ”¹åŒä¸€æ•°æ®ï¼Œç»“æœä¸å¯é¢„æµ‹");
    println!();

    // --------------------------------------------------------
    // ğŸ“Œ è§„åˆ™ï¼šå¯å˜å€Ÿç”¨ä¸ä¸å¯å˜å€Ÿç”¨ä¸èƒ½å…±å­˜
    // --------------------------------------------------------
    println!("ã€3ã€‘å¯å˜å€Ÿç”¨ä¸ä¸å¯å˜å€Ÿç”¨ä¸èƒ½åŒæ—¶å­˜åœ¨");
    println!();

    let mut text = String::from("æ–‡æœ¬");

    let r_read = &text;  // ä¸å¯å˜å€Ÿç”¨
    println!("  åˆ›å»ºä¸å¯å˜å€Ÿç”¨: r_read = \"{}\"", r_read);

    // let r_write = &mut text;  // âŒ ç¼–è¯‘é”™è¯¯ï¼
    // println!("{}", r_read);    // å¦‚æœ r_read è¿˜åœ¨ä½¿ç”¨ï¼Œå°±ä¸èƒ½åˆ›å»º &mut

    // ä½†æ˜¯ï¼Œå¦‚æœä¸å¯å˜å€Ÿç”¨ç”¨å®Œäº†ï¼Œå°±å¯ä»¥åˆ›å»ºå¯å˜å€Ÿç”¨
    println!("  r_read ä½¿ç”¨å®Œæ¯•å...");

    let r_write = &mut text;  // âœ… ç°åœ¨å¯ä»¥äº†
    r_write.push_str("_ä¿®æ”¹");
    println!("  åˆ›å»ºå¯å˜å€Ÿç”¨å¹¶ä¿®æ”¹: \"{}\"", r_write);
    println!();

    // --------------------------------------------------------
    // ğŸ“Œ å€Ÿç”¨çš„ä½œç”¨åŸŸï¼ˆNLL - Non-Lexical Lifetimesï¼‰
    // --------------------------------------------------------
    println!("ã€4ã€‘å€Ÿç”¨çš„ä½œç”¨åŸŸï¼ˆNLLï¼‰");
    println!();

    let mut value = String::from("hello");

    let r1 = &value;
    let r2 = &value;
    println!("  r1 = \"{}\"", r1);
    println!("  r2 = \"{}\"", r2);
    // r1 å’Œ r2 åœ¨è¿™é‡Œä¹‹åä¸å†ä½¿ç”¨ï¼Œæ‰€ä»¥å®ƒä»¬çš„ç”Ÿå‘½å‘¨æœŸç»“æŸäº†

    let r3 = &mut value;  // âœ… å¯ä»¥åˆ›å»ºå¯å˜å€Ÿç”¨
    r3.push_str(" world");
    println!("  r3 ä¿®æ”¹å = \"{}\"", r3);
    println!();

    println!("  ğŸ’¡ Rust 2018+ å¼•å…¥äº† NLLï¼ˆéè¯æ³•ç”Ÿå‘½å‘¨æœŸï¼‰");
    println!("     å€Ÿç”¨çš„ç”Ÿå‘½å‘¨æœŸåœ¨ã€Œæœ€åä¸€æ¬¡ä½¿ç”¨ã€æ—¶ç»“æŸ");
    println!("     è€Œä¸æ˜¯åœ¨ '}}' å¤„ç»“æŸ");
    println!();

    // --------------------------------------------------------
    // ğŸ“Œ å‡½æ•°ä¸­çš„å¯å˜å€Ÿç”¨
    // --------------------------------------------------------
    println!("ã€5ã€‘å‡½æ•°ä¸­ä½¿ç”¨å¯å˜å€Ÿç”¨");
    println!();

    let mut numbers = vec![1, 2, 3];
    println!("  ä¿®æ”¹å‰: {:?}", numbers);

    add_element(&mut numbers, 4);
    add_element(&mut numbers, 5);

    println!("  ä¿®æ”¹å: {:?}", numbers);
    println!();

    // --------------------------------------------------------
    // ğŸ“Œ å¯å˜å€Ÿç”¨çš„å®é™…åº”ç”¨
    // --------------------------------------------------------
    println!("ã€6ã€‘å®é™…åº”ç”¨ç¤ºä¾‹");
    println!();

    // ç¤ºä¾‹1ï¼šå­—ç¬¦ä¸²æ“ä½œ
    let mut message = String::from("Hello");
    append_greeting(&mut message, "JohnYe");
    println!("  é—®å€™è¯­: \"{}\"", message);

    // ç¤ºä¾‹2ï¼šVec æ“ä½œ
    let mut scores = vec![85, 90, 78];
    normalize_scores(&mut scores);
    println!("  æ ‡å‡†åŒ–åˆ†æ•°: {:?}", scores);
    println!();

    // --------------------------------------------------------
    // ğŸ“Œ å¸¸è§é”™è¯¯ä¸è§£å†³æ–¹æ¡ˆ
    // --------------------------------------------------------
    println!("ã€7ã€‘å¸¸è§é”™è¯¯æ€»ç»“");
    println!();
    println!("  é”™è¯¯1: åŒæ—¶åˆ›å»ºå¤šä¸ª &mut");
    println!("    let r1 = &mut s;");
    println!("    let r2 = &mut s;  // âŒ");
    println!("    è§£å†³: åˆ†å¼€ä½¿ç”¨ï¼Œç”¨å®Œä¸€ä¸ªå†åˆ›å»ºå¦ä¸€ä¸ª");
    println!();
    println!("  é”™è¯¯2: &T å’Œ &mut T å…±å­˜");
    println!("    let r1 = &s;");
    println!("    let r2 = &mut s;  // âŒ å¦‚æœ r1 è¿˜åœ¨ä½¿ç”¨");
    println!("    è§£å†³: ç¡®ä¿ä¸å¯å˜å€Ÿç”¨ç”¨å®Œåå†åˆ›å»ºå¯å˜å€Ÿç”¨");
    println!();
    println!("  é”™è¯¯3: åœ¨å¾ªç¯ä¸­å€Ÿç”¨");
    println!("    for item in &mut vec {{");
    println!("        vec.push(item);  // âŒ ä¸èƒ½åœ¨è¿­ä»£æ—¶ä¿®æ”¹");
    println!("    }}");
    println!("    è§£å†³: æ”¶é›†è¦ä¿®æ”¹çš„å†…å®¹ï¼Œå¾ªç¯åç»Ÿä¸€å¤„ç†");
    println!();

    // --------------------------------------------------------
    // ğŸ“Œ æ‰€æœ‰æƒè§„åˆ™å®Œæ•´æ€»ç»“
    // --------------------------------------------------------
    println!("ã€8ã€‘æ‰€æœ‰æƒä¸å€Ÿç”¨è§„åˆ™æ€»ç»“");
    println!();
    println!("  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”");
    println!("  â”‚             Rust æ‰€æœ‰æƒä¸‰å¤§é“å¾‹                â”‚");
    println!("  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤");
    println!("  â”‚ 1. æ¯ä¸ªå€¼æœ‰ä¸”åªæœ‰ä¸€ä¸ªæ‰€æœ‰è€…                   â”‚");
    println!("  â”‚ 2. åŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªæ‰€æœ‰è€…                   â”‚");
    println!("  â”‚ 3. æ‰€æœ‰è€…ç¦»å¼€ä½œç”¨åŸŸæ—¶ï¼Œå€¼è¢«è‡ªåŠ¨é‡Šæ”¾           â”‚");
    println!("  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜");
    println!();
    println!("  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”");
    println!("  â”‚             å€Ÿç”¨è§„åˆ™ï¼ˆå¼•ç”¨çš„é“å¾‹ï¼‰             â”‚");
    println!("  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤");
    println!("  â”‚ 1. ä»»æ„æ—¶åˆ»ï¼šè¦ä¹ˆä¸€ä¸ª &mutï¼Œè¦ä¹ˆå¤šä¸ª &T       â”‚");
    println!("  â”‚ 2. å¼•ç”¨å¿…é¡»å§‹ç»ˆæœ‰æ•ˆï¼ˆä¸èƒ½æ‚¬å‚ï¼‰               â”‚");
    println!("  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜");
    println!();

    println!("=== æ­å–œï¼æ‰€æœ‰æƒåŸºç¡€å­¦ä¹ å®Œæˆï¼ ===");
    println!();
    println!("ğŸ“š å­¦ä¹ è·¯å¾„å›é¡¾:");
    println!("   01 - æ‰€æœ‰æƒåŸºç¡€æ¦‚å¿µ");
    println!("   02 - Move è¯­ä¹‰");
    println!("   03 - Copy ä¸ Clone");
    println!("   04 - ä¸å¯å˜å€Ÿç”¨");
    println!("   05 - å¯å˜å€Ÿç”¨ âœ… (å½“å‰)");
    println!();
    println!("ğŸ¯ ä¸‹ä¸€æ­¥å»ºè®®:");
    println!("   - ç”Ÿå‘½å‘¨æœŸï¼ˆLifetimesï¼‰");
    println!("   - æ™ºèƒ½æŒ‡é’ˆï¼ˆBox, Rc, RefCellï¼‰");
    println!("   - åˆ‡ç‰‡ï¼ˆSlicesï¼‰");

    wait_for_enter();
}

fn add_element(vec: &mut Vec<i32>, value: i32) {
    vec.push(value);
    println!("  æ·»åŠ å…ƒç´  {} -> å½“å‰: {:?}", value, vec);
}

fn append_greeting(s: &mut String, name: &str) {
    s.push_str(", ");
    s.push_str(name);
    s.push('!');
}

fn normalize_scores(scores: &mut Vec<i32>) {
    let max = *scores.iter().max().unwrap_or(&100) as f64;
    for score in scores.iter_mut() {
        *score = ((*score as f64 / max) * 100.0) as i32;
    }
}

fn wait_for_enter() {
    use std::io::{self, Write};
    println!();
    print!("æŒ‰å›è½¦é”®é€€å‡º...");
    io::stdout().flush().unwrap();
    let mut input = String::new();
    io::stdin().read_line(&mut input).unwrap();
}
